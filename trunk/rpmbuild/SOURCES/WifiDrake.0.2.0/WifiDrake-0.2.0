#!/bin/bash
# Para mantener la wifi activa, aun cuando cae reiteradamente para encriptaciones tipo WEB
# Script under GPL V3
# Eduard Vidal i Tulsa  linux user 275003 (Reconecta Original)
# kapyderi (Adaptado del original con muchas mejoras para que realice ataques continuos, cada minuto y no la deje caer)
# kapyderi (Creador del rpm para mandriva)
# Nombre: WifiDrake
# Versión: 0.2.0

ScriptVersion="0.2.0"
USER="`w|awk 'NR>2 {print $1}'|cut -d '' -f 2`"
export IFS=" "
if [ -z "`which	zenity`" ]; then
  echo "Necesita zenity para ejecutar WifiDrake,
  por favor instalelo desde urpmi"
  exit 1;
fi

if [ "`whoami`" = "root" ]; then
 if [ "$#" = 0 ]; then
    zenity --question --title="WifiDrake by Kapyderi" --text="
    Kapyderi 2010

    WifiDrake 0.2.0 [Licencia: GPL 3 ó superior]

    Este script pretende que la wifi, cuando esta fallida, 
    y no para de desactivarse, hace que fuerze, cada minuto, 
    su ejecución de manera automatica, si esta activo.

    Este programa solo funciona con encriptaciones tipo WEB
    
    Utilizelo bajo su criterio, ya que no hay ninguna garantia
    por el creador.

    Espero que lo disfruten, como yo realizandolo. Gracias por 
    usarlo.

    ¿Desea Continuar?" --ok-label="Continuar" --cancel-label="Salir";
    if [ "$?" = 1 ]; then exit 1; fi;
 fi
 conexion=`wc /root/wifidrake.log | cut -d ' ' -f2` 
 echo "Creando configuración de usuario..."
 user=`zenity --entry \
        --title="Nombre del usuario" \
        --text="Introduzca el nombre del usuario donde se generará el fichero .log:" \
        --entry-text="$USER"`
   zenity --info --text="
   El usuario donde se generará el fichero .log, será en...

   $user

   La ruta será /home/$user/reconecta.log"  
 if [ "$#" = 0 ]; then
  zenity --question --title="Activar wifiDrake" --text="
 Esta opción activa o desactiva WifiDrake

  ¿Activar WifiDrake?" --ok-label="Activar" --cancel-label="Desactivar";
  if [ "$?" = 1 ]; then
   echo "Borrando configuración anterior...espere por favor."
   rm -f /root/reconecta
   if [ "1" = $conexion ]; then
    crontab -l > /root/crontab_old
   else 
    crontab /root/crontab_old
   fi
  else
   echo "Borrando configuración anterior...espere por favor."
   rm -f /root/reconecta
   if [ "1" = $conexion ]; then
    crontab -l > /root/crontab_old
   else
    crontab /root/crontab_old
   fi
   echo "Creando configuración..."
   DEV=`zenity --entry \
        --title="Nombre de dispositivo" \
        --text="Introduzca el nombre de su dispotivo inalambrico (Ejemplo: wlan0):" \
        --entry-text="wlan0"` 
   ESSID=`zenity --entry \
        --title="ESSID de la red" \
        --text="Introduzca el ESSID de su dispositivo inalambrico (ejemplo: WLAN_7F):" \
        --entry-text="WLAN_7F"` 
   KEY=`zenity --entry \
        --title="CLAVE KEY de la red" \
        --text="Introduzca la CLAVE WEB de su dispositivo inalambrico (Ejemplo: Z0002CFC16C7F):" \
        --entry-text="Z0002CFC16C7F"`
   DGY=`zenity --entry \
        --title="Puera de enlace" \
        --text="Introduzca la puerta de enlace de su router (Ejemplo: 192.168.1.1):" \
        --entry-text="192.168.1.1"`
   zenity --info --text="
   Los datos introducidos son...

   Nombre de dispositivo: $DEV
   ESSID: $ESSID
   KEY: $KEY
   DGY: $DGY"
   echo "Generando fichero con su configuración..."
   echo "
   #!/bin/bash
   #
   # Script under GPL V3
   # Eduard Vidal i Tulsa  linux user 275003 (Original)
   # kapyderi (Adaptado del original con muchas mejoras para que realice ataques continuos, cada minuto y no la deje caer)
   # Tambien modifica directamente el crontab de root xD
   # kapyderi (Creador del rpm de Mandriva)
   # iwconfig
   DEV=$DEV                       # Dispositivo inalambrico
   ESSID="$ESSID"                 # ESSID de la red
   KEY=$KEY                       # Clave WEP
   DGY=$DGY                       # Puerta de enlace" >> /root/reconecta
   `cat /usr/sbin/datos_wifi >> /root/reconecta`
   echo "Dando permisos al fichero creado:.."
   chmod 770 /root/reconecta
   echo "Instalando linea de ajuste en el crontab de root..."
   cp /root/crontab_old /root/crontab_tmp
   echo "*/1 * * * * sudo /root/reconecta >> /home/$user/reconecta.log" >> /root/crontab_tmp
   crontab /root/crontab_tmp
   rm -f /root/crontab_tmp
   echo "Proceso realizado." >> /root/wifidrake.log
  fi
 fi
   #Mensaje Final
  zenity --info --text="Felicidades $user, se han realizado con exito las tareas solicitadas."
  exit 0
else
 zenity --warning --text="WifiDrake debe ser ejecutado por root"
 exit 1;
fi

